{% raw %}<!--
  PUBLICATIONS.HTML — Publication Card Template
  ==============================================
  This is an _includes partial that renders ONE publication card.
  It's included by the publications page using a loop:
    {% for publication in site.data.publications %}
      {% include publications.html %}
    {% endfor %}

  CONTEXT:
  The "publication" variable comes from _data/publications.yml.
  Each publication entry can have these fields:
    title:        "Paper title"
    doi:          "10.xxxx/xxxxx"      (DOI identifier — number only or full URL)
    image:        "thumbnail.jpg"       (filename in /images/publications/)
    description:  "Short summary..."    (optional)
    authors:      "Author A, Author B"  (optional)
    venue:        "Journal Name, 2024"  (optional)
    number_link:  3                     (how many extra links to show, 0-6)
    link1:
      url:     "paper.pdf"              (filename or full URL)
      display: "PDF"                    (link label text)
    link2:
      url:     "https://github.com/..."
      display: "Code"
    ... up to link6

  LIQUID TAGS USED:
  {% assign x = value %}     → creates a local variable
  {{ variable }}             → outputs a value
  {% if condition %}         → conditional block
  {% for i in (1..n) %}      → loop from 1 to n
  | default: ""              → fallback value if the field is missing
  | append: text             → concatenates text to a string
  contains                   → checks if a string includes a substring

  STYLES: Defined in _style.scss under "Publications page (cards)".
-->{% endraw %}

<!-- .publications: the card container with border + shadow -->
<div class="publications">

    <!-- ──────────────────────────────────────────────
         STEP 1: Build the DOI URL
         ──────────────────────────────────────────────
         If a DOI is provided, ensure it's a full URL.
         Some entries have just "10.xxxx/xxxxx" while others have
         the full "https://doi.org/10.xxxx/xxxxx".
         This block normalizes both to a full URL. -->

    <!-- Start with the DOI value (or empty string if not set) -->
    {% assign doi_url = publication.doi | default: "" %}

    {% if doi_url != "" %}
        <!-- If the DOI doesn't already contain "doi.org", prepend the URL prefix -->
        {% unless doi_url contains "doi.org" %}
            {% assign doi_url = "https://doi.org/" | append: doi_url %}
        {% endunless %}
    {% endif %}

    <!-- ──────────────────────────────────────────────
         STEP 2: Build the PDF URL
         ──────────────────────────────────────────────
         If link1 has a URL, check if it's a full URL or a local filename.
         Local filenames get the site's /docs/publications/ path prepended. -->

    {% assign pdf_url = publication.link1.url | default: "" %}

    <!-- If the URL doesn't contain "://" it's a local filename → build the full path -->
    {% unless pdf_url contains "://" %}
        {% assign pdf_url = site.url | append: site.baseurl | append: "/docs/publications/" | append: pdf_url %}
    {% endunless %}

    <!-- ──────────────────────────────────────────────
         STEP 3: Choose the primary URL
         ──────────────────────────────────────────────
         The title and thumbnail link to this URL.
         Prefer DOI if available; fall back to PDF link. -->

    {% assign primary_url = doi_url %}
    {% if primary_url == "" %}{% assign primary_url = pdf_url %}{% endif %}

    <!-- ──────────────────────────────────────────────
         STEP 4: Render the card
         ────────────────────────────────────────────── -->

    <!-- Publication title (linked to DOI or PDF) -->
    <!-- target="_blank" opens in a new tab.
         rel="noopener" is a security measure for _blank links. -->
    <a href="{{ primary_url }}" target="_blank" rel="noopener">
        <!-- .publication-title: styled in _style.scss (green, bold, 20px) -->
        <div class="publication-title">{{ publication.title }}</div>
    </a>

    <!-- Thumbnail image (floated left of the text) -->
    <a href="{{ primary_url }}" target="_blank" rel="noopener">
        <!-- .publication-picture: floated left, max-width 15%, rounded corners.
             The image file lives in /images/publications/.
             publication.image is the filename from _data/publications.yml. -->
        <img class="publication-picture"
             src="{{site.url}}{{site.baseurl}}/images/publications/{{ publication.image }}"
             alt="{{ publication.title }}" />
    </a>

    <!-- Text area: description, authors, venue, links -->
    <!-- .publication-text: left margin of 25% clears the floated thumbnail -->
    <div class="publication-text">

        {% raw %}<!-- Optional fields: only rendered if they exist in the YAML data.
             {% if publication.description %} checks for the field. -->{% endraw %}
        {% if publication.description %}<p>{{ publication.description }}</p>{% endif %}

        <!-- Authors in italics (<em> = emphasis = italic) -->
        {% if publication.authors %}<p><em>{{ publication.authors }}</em></p>{% endif %}

        <!-- Venue (journal name, year) -->
        {% if publication.venue %}<p>{{ publication.venue }}</p>{% endif %}

        <!-- ──────────────────────────────────────────────
             STEP 5: Render extra links (1 through 6)
             ──────────────────────────────────────────────
             Uses a Liquid loop instead of repeating the same code 6 times.
             number_link in the YAML controls how many links to show.

             How the loop works:
             1. max_links = publication.number_link (e.g., 3)
             2. Loop from 1 to 3
             3. Build the key name: "link1", "link2", "link3"
             4. Look up publication["link1"], publication["link2"], etc.
             5. If the link exists, render it as a clickable <a> tag
             6. Separate links with " | " (pipe character) -->

        {% assign max_links = publication.number_link | default: 0 %}

        {% if max_links > 0 %}
            <p>
                {% for i in (1..max_links) %}
                    <!-- Build the key dynamically: "link" + loop index → "link1", "link2", etc. -->
                    {% assign key = "link" | append: i %}

                    <!-- Look up the link object from the publication data -->
                    {% assign link = publication[key] %}

                    {% if link %}
                        <!-- Add a " | " separator between links (but not before the first one).
                             forloop.first is true only on the first iteration. -->
                        {% if forloop.first == false %} | {% endif %}

                        <!-- If the URL contains "://" it's an external link.
                             Otherwise, it's a local file in /docs/publications/. -->
                        {% if link.url contains "://" %}
                            <a href="{{ link.url }}" target="_blank">{{ link.display }}</a>
                        {% else %}
                            <a href="{{site.url}}{{site.baseurl}}/docs/publications/{{ link.url }}" target="_blank">{{ link.display }}</a>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </p>
        {% endif %}

    </div>

</div>
